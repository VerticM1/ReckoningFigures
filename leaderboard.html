<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - Reckoning Figures</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap');
        
        :root {
            --bg-primary: #1F2937;
            --bg-card: #2D3748;
            --bg-card-hover: #374151;
            --border: #4A5568;
            --text: #ffffff;
            --text-muted: #9CA3AF;
            --text-dim: #6B7280;
            --primary: #58CC02;
            --primary-dark: #45A302;
            --secondary: #7C3AED;
            --accent: #FFA500;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Header */
        #header {
            background: linear-gradient(135deg, var(--secondary) 0%, #5B21B6 100%);
            padding: 30px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .header-title {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 12px;
        }

        .league-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 900;
            text-transform: uppercase;
        }

        /* Toggle */
        .view-toggle {
            padding: 20px;
            display: flex;
            gap: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: var(--text-muted);
            cursor: pointer;
            text-transform: uppercase;
        }

        .toggle-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Leaderboard */
        #leaderboard {
            padding: 0 20px 20px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .your-rank-card {
            background: var(--primary);
            border: 3px solid var(--primary-dark);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .rank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .rank-number {
            font-size: 48px;
            font-weight: 900;
        }

        .rank-xp {
            font-size: 24px;
            font-weight: 900;
        }

        .rank-username {
            font-size: 20px;
            font-weight: 900;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-item {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .leaderboard-item.highlight {
            border-color: var(--primary);
            background: rgba(88, 204, 2, 0.1);
        }

        .item-rank {
            font-size: 24px;
            font-weight: 900;
            width: 40px;
            text-align: center;
        }

        .item-rank.top3 {
            color: var(--accent);
        }

        .item-info {
            flex: 1;
        }

        .item-username {
            font-size: 18px;
            font-weight: 900;
            margin-bottom: 4px;
        }

        .item-stats {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-muted);
        }

        .item-xp {
            font-size: 20px;
            font-weight: 900;
            color: var(--primary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-muted);
        }

        /* Empty */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-muted);
        }

        /* Bottom Nav */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            width: 28px;
            height: 28px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <div class="header-content">
            <div class="header-title">Leaderboard</div>
            <div class="league-badge">
                <span id="league-name">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Toggle -->
    <div class="view-toggle">
        <button class="toggle-btn active" id="toggle-all">All Players</button>
        <button class="toggle-btn" id="toggle-friends">Friends Only</button>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard">
        <div class="loading">Loading leaderboard...</div>
    </div>

    <!-- Bottom Nav -->
    <div id="bottom-nav">
        <div class="nav-item" onclick="navigateTo('main-menu-modules.html')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
            </svg>
            <div>Learn</div>
        </div>
        <div class="nav-item active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.5 21H2V9h5.5v12zm7.25-18h-5.5v18h5.5V3zM22 11h-5.5v10H22V11z"/>
            </svg>
            <div>Leaderboard</div>
        </div>
        <div class="nav-item" onclick="navigateTo('friends.html')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            <div>Friends</div>
        </div>
        <div class="nav-item" onclick="navigateTo('profile.html')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
            <div>Profile</div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="firebase-friends-system.js"></script>

    <script>
        const auth = window.firebaseAuth;
        const db = window.firebaseDB;
        let friendsSystem;
        let currentUser = null;
        let viewMode = 'all'; // 'all' or 'friends'
        let unsubscribe = null;

        const LEAGUES = {
            bronze: { name: 'Bronze', min: 0, max: 199, color: '#CD7F32' },
            silver: { name: 'Silver', min: 200, max: 499, color: '#C0C0C0' },
            gold: { name: 'Gold', min: 500, max: 999, color: '#FFD700' },
            diamond: { name: 'Diamond', min: 1000, max: Infinity, color: '#B9F2FF' }
        };

        function navigateTo(page) {
            window.location.href = page;
        }

        function getLeague(xp) {
            if (xp >= 1000) return LEAGUES.diamond;
            if (xp >= 500) return LEAGUES.gold;
            if (xp >= 200) return LEAGUES.silver;
            return LEAGUES.bronze;
        }

        async function init() {
            // Check auth
            await new Promise((resolve) => {
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (!user) {
                        window.location.href = 'auth.html';
                    } else {
                        resolve();
                    }
                });
            });

            // Initialize friends system
            friendsSystem = new FirebaseFriendsSystem();
            await friendsSystem.waitForAuth();

            // Get current user data
            const userData = await friendsSystem.getCurrentUserData();
            if (userData) {
                const league = getLeague(userData.xp || 0);
                document.getElementById('league-name').textContent = league.name + ' League';
            }

            // Set up toggles
            document.getElementById('toggle-all').addEventListener('click', () => switchView('all'));
            document.getElementById('toggle-friends').addEventListener('click', () => switchView('friends'));

            // Load initial leaderboard
            await loadLeaderboard();
        }

        function switchView(mode) {
            viewMode = mode;
            
            // Update buttons
            document.getElementById('toggle-all').classList.toggle('active', mode === 'all');
            document.getElementById('toggle-friends').classList.toggle('active', mode === 'friends');
            
            // Reload leaderboard
            loadLeaderboard();
        }

        async function loadLeaderboard() {
            const container = document.getElementById('leaderboard');
            container.innerHTML = '<div class="loading">Loading leaderboard...</div>';

            // Unsubscribe from previous listener
            if (unsubscribe) {
                unsubscribe();
            }

            try {
                if (viewMode === 'all') {
                    await loadAllPlayers();
                } else {
                    await loadFriendsOnly();
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">Failed to Load</div>
                        <div class="empty-text">Please refresh the page</div>
                    </div>
                `;
            }
        }

        async function loadAllPlayers() {
            // Real-time listener for all users
            unsubscribe = db.collection('users')
                .orderBy('xp', 'desc')
                .limit(100)
                .onSnapshot(async (snapshot) => {
                    const users = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        users.push({
                            userId: doc.id,
                            userName: data.userName,
                            xp: data.xp || 0,
                            streak: data.streak || 0
                        });
                    });

                    displayLeaderboard(users);
                });
        }

        async function loadFriendsOnly() {
            const friends = await friendsSystem.getFriends();
            
            if (friends.length === 0) {
                document.getElementById('leaderboard').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">No Friends Yet</div>
                        <div class="empty-text">Add friends to see them on the leaderboard!</div>
                    </div>
                `;
                return;
            }

            // Get current user data
            const userData = await friendsSystem.getCurrentUserData();
            
            // Combine current user + friends
            const allUsers = [
                {
                    userId: currentUser.uid,
                    userName: userData.userName,
                    xp: userData.xp || 0,
                    streak: userData.streak || 0
                },
                ...friends
            ];

            // Sort by XP
            allUsers.sort((a, b) => b.xp - a.xp);

            displayLeaderboard(allUsers);

            // Set up real-time listener for friends
            const friendIds = friends.map(f => f.userId);
            if (friendIds.length > 0) {
                unsubscribe = db.collection('users')
                    .where(firebase.firestore.FieldPath.documentId(), 'in', friendIds.concat([currentUser.uid]))
                    .onSnapshot(async (snapshot) => {
                        const users = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            users.push({
                                userId: doc.id,
                                userName: data.userName,
                                xp: data.xp || 0,
                                streak: data.streak || 0
                            });
                        });
                        users.sort((a, b) => b.xp - a.xp);
                        displayLeaderboard(users);
                    });
            }
        }

        function displayLeaderboard(users) {
            const container = document.getElementById('leaderboard');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">No Players Yet</div>
                        <div class="empty-text">Be the first to start learning!</div>
                    </div>
                `;
                return;
            }

            let html = '';
            
            // Find current user's rank
            const userRank = users.findIndex(u => u.userId === currentUser.uid);
            
            if (userRank !== -1) {
                const userData = users[userRank];
                html += `
                    <div class="your-rank-card">
                        <div class="rank-header">
                            <div class="rank-number">#${userRank + 1}</div>
                            <div class="rank-xp">${userData.xp} XP</div>
                        </div>
                        <div class="rank-username">${userData.userName} (You)</div>
                    </div>
                `;
            }

            html += '<div class="leaderboard-list">';
            
            users.forEach((user, index) => {
                const isUser = user.userId === currentUser.uid;
                const isTop3 = index < 3;
                
                html += `
                    <div class="leaderboard-item ${isUser ? 'highlight' : ''}">
                        <div class="item-rank ${isTop3 ? 'top3' : ''}">#${index + 1}</div>
                        <div class="item-info">
                            <div class="item-username">${user.userName}${isUser ? ' (You)' : ''}</div>
                            <div class="item-stats">${user.streak} day streak</div>
                        </div>
                        <div class="item-xp">${user.xp}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Theme system
        function loadTheme() {
            const THEMES = {
                dark: { colors: { '--bg-primary': '#1F2937', '--bg-card': '#2D3748', '--bg-card-hover': '#374151', '--border': '#4A5568', '--text': '#ffffff', '--text-muted': '#9CA3AF', '--text-dim': '#6B7280', '--primary': '#58CC02', '--primary-dark': '#45A302', '--secondary': '#7C3AED', '--accent': '#FFA500' }},
                light: { colors: { '--bg-primary': '#F9FAFB', '--bg-card': '#FFFFFF', '--bg-card-hover': '#F3F4F6', '--border': '#E5E7EB', '--text': '#1F2937', '--text-muted': '#6B7280', '--text-dim': '#9CA3AF', '--primary': '#10B981', '--primary-dark': '#059669', '--secondary': '#8B5CF6', '--accent': '#F59E0B' }},
                ocean: { colors: { '--bg-primary': '#0F172A', '--bg-card': '#1E293B', '--bg-card-hover': '#334155', '--border': '#475569', '--text': '#F1F5F9', '--text-muted': '#94A3B8', '--text-dim': '#64748B', '--primary': '#06B6D4', '--primary-dark': '#0891B2', '--secondary': '#3B82F6', '--accent': '#8B5CF6' }},
                sunset: { colors: { '--bg-primary': '#1C1917', '--bg-card': '#292524', '--bg-card-hover': '#44403C', '--border': '#57534E', '--text': '#FAFAF9', '--text-muted': '#A8A29E', '--text-dim': '#78716C', '--primary': '#F97316', '--primary-dark': '#EA580C', '--secondary': '#EF4444', '--accent': '#FBBF24' }},
                forest: { colors: { '--bg-primary': '#14532D', '--bg-card': '#166534', '--bg-card-hover': '#15803D', '--border': '#16A34A', '--text': '#F0FDF4', '--text-muted': '#BBF7D0', '--text-dim': '#86EFAC', '--primary': '#4ADE80', '--primary-dark': '#22C55E', '--secondary': '#10B981', '--accent': '#FDE047' }},
                midnight: { colors: { '--bg-primary': '#1E1B4B', '--bg-card': '#312E81', '--bg-card-hover': '#3730A3', '--border': '#4C1D95', '--text': '#F5F3FF', '--text-muted': '#C4B5FD', '--text-dim': '#A78BFA', '--primary': '#A855F7', '--primary-dark': '#9333EA', '--secondary': '#EC4899', '--accent': '#F472B6' }}
            };
            
            const savedTheme = localStorage.getItem('reckonTheme') || 'dark';
            const theme = THEMES[savedTheme];
            if (theme) {
                const root = document.documentElement;
                Object.entries(theme.colors).forEach(([property, value]) => {
                    root.style.setProperty(property, value);
                });
            }
        }
        
        loadTheme();
        init();
    </script>
</body>
</html>
