<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - Reckoning Figures</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap');
        :root {
            --bg-primary: #1F2937;
            --bg-card: #2D3748;
            --bg-card-hover: #374151;
            --border: var(--border);
            --border-hover: #5a6573;
            --text: #ffffff;
            --text-muted: #9CA3AF;
            --text-dim: #6B7280;
            --primary: #58CC02;
            --primary-dark: #45A302;
            --secondary: #7C3AED;
            --secondary-dark: #5B21B6;
            --accent: #FFA500;
            --accent-dark: #FF6B00;
        }
        

        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* Header */
        #header {
            padding: 20px;
            background: var(--bg-primary);
            border-bottom: 2px solid #374151;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--text);
            text-align: center;
            margin-bottom: 16px;
        }

        /* Time Period Tabs */
        .time-tabs {
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 4px;
        }

        .time-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Nunito', sans-serif;
            font-size: 14px;
            font-weight: 800;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-tab.active {
            background: var(--primary);
            color: var(--text);
        }

        /* Main Content */
        #content {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* User Position Card */
        .user-position-card {
            background: linear-gradient(135deg, #FFA500 0%, #FF6B00 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            border: 3px solid #FFD700;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .your-rank {
            font-size: 16px;
            font-weight: 900;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .rank-number {
            font-size: 48px;
            font-weight: 900;
            color: var(--text);
            text-align: center;
            margin-bottom: 8px;
        }

        .rank-suffix {
            font-size: 24px;
            vertical-align: super;
        }

        .your-xp {
            font-size: 20px;
            font-weight: 800;
            color: var(--text);
            text-align: center;
        }

        /* Section Headers */
        .section-header {
            font-size: 18px;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Leaderboard List */
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-item {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 2px solid #4A5568;
            transition: transform 0.2s ease;
        }

        .leaderboard-item:hover {
            transform: scale(1.02);
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, #2D3748 0%, #3a3748 100%);
        }

        .leaderboard-item.rank-1 {
            border-color: #FFD700;
        }

        .leaderboard-item.rank-2 {
            border-color: #C0C0C0;
        }

        .leaderboard-item.rank-3 {
            border-color: #CD7F32;
        }

        .leaderboard-item.current-user {
            border-color: var(--accent);
            background: linear-gradient(135deg, #3a2f1f 0%, #2D3748 100%);
        }

        .rank {
            width: 40px;
            font-size: 24px;
            font-weight: 900;
            text-align: center;
        }

        .rank-1 .rank {
            color: #FFD700;
        }

        .rank-2 .rank {
            color: #C0C0C0;
        }

        .rank-3 .rank {
            color: #CD7F32;
        }

        .medal {
            width: 32px;
            height: 32px;
        }

        .player-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar-small {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card-hover);
            border: 2px solid #4A5568;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
            color: var(--text-muted);
        }

        .current-user .avatar-small {
            border-color: var(--accent);
            color: var(--accent);
        }

        .rank-1 .avatar-small {
            border-color: #FFD700;
        }

        .rank-2 .avatar-small {
            border-color: #C0C0C0;
        }

        .rank-3 .avatar-small {
            border-color: #CD7F32;
        }

        .player-name {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .country-flag {
            font-size: 20px;
        }

        .current-user .player-name {
            color: var(--accent);
        }

        .player-xp {
            font-size: 20px;
            font-weight: 900;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .xp-icon {
            width: 20px;
            height: 20px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-text {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-muted);
        }

        /* Stats Footer */
        .stats-footer {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-top: 24px;
            border: 2px solid #4A5568;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Bottom Navigation */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid #374151;
            display: flex;
            justify-content: space-around;
            padding: 12px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            width: 28px;
            height: 28px;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <div class="header-title">Leaderboard</div>
        <div class="time-tabs">
            <button class="time-tab active" onclick="switchLeaderboard('xp')">XP Rankings</button>
            <button class="time-tab" onclick="switchLeaderboard('streak')">Question Streaks</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="content">
        <!-- League Badge -->
        <div style="background: linear-gradient(135deg, #7C3AED 0%, #5B21B6 100%); border: 3px solid #8B5CF6; border-radius: 20px; padding: 20px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 14px; font-weight: 800; color: #DDD6FE; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Your League</div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                <svg id="league-icon" viewBox="0 0 24 24" style="width: 48px; height: 48px;">
                    <path fill="#CD7F32" d="M12,15.39L8.24,17.66L9.23,13.38L5.91,10.5L10.29,10.13L12,6.09L13.71,10.13L18.09,10.5L14.77,13.38L15.76,17.66M22,9.24L14.81,8.63L12,2L9.19,8.63L2,9.24L7.45,13.97L5.82,21L12,17.27L18.18,21L16.54,13.97L22,9.24Z"/>
                </svg>
                <div>
                    <div style="font-size: 28px; font-weight: 900; color: var(--text);" id="league-name">Bronze League</div>
                    <div style="font-size: 14px; font-weight: 700; color: #C4B5FD;" id="league-advancement"></div>
                </div>
            </div>
        </div>

        <!-- User Position Card -->
        <div class="user-position-card">
            <div class="position-header">
                <div class="your-rank">Your Rank</div>
            </div>
            <div class="rank-number">
                <span id="user-rank">12</span><span class="rank-suffix">th</span>
            </div>
            <div class="your-xp" id="user-stat-display">
                <span id="user-xp-display">0</span> XP
            </div>
        </div>

        <!-- Top Players -->
        <div class="section-header">Top Players</div>
        <div class="leaderboard-list" id="leaderboard-list">
            <!-- Leaderboard items will be populated here -->
        </div>

        <!-- Stats Footer -->
        <div class="stats-footer">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-players">47</div>
                    <div class="stat-label">Players</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-xp">284</div>
                    <div class="stat-label">Avg XP</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="top-xp">1,250</div>
                    <div class="stat-label">Top XP</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div id="bottom-nav">
        <div class="nav-item" onclick="navigateTo('main-menu-modules.html')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
            </svg>
            <div>Learn</div>
        </div>
        <div class="nav-item active">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path fill="currentColor" d="M7.5 21H2V9h5.5v12zm7.25-18h-5.5v18h5.5V3zM22 11h-5.5v10H22V11z"/>
            </svg>
            <div>Leaderboard</div>
        </div>
        <div class="nav-item" onclick="navigateTo('friends.html')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            <div>Friends</div>
        </div>
        <div class="nav-item" onclick="navigateTo('profile.html')">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
            <div>Profile</div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auto-sync.js"></script>

    <script>
        // Load saved theme
        const savedTheme = localStorage.getItem('reckonTheme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        
        function navigateTo(page) {
            window.location.href = page;
        }
        
        // Load user progress
        const userProgress = JSON.parse(localStorage.getItem('reckonProgress') || '{"xp": 0, "userName": "Player", "bestQuestionStreak": 0}');

        // League System
        function getLeague(xp) {
            if (xp >= 1000) return { name: 'Diamond League', color: '#60A5FA', next: null };
            if (xp >= 500) return { name: 'Gold League', color: '#FFA500', next: 'Diamond' };
            if (xp >= 200) return { name: 'Silver League', color: '#9CA3AF', next: 'Gold' };
            return { name: 'Bronze League', color: '#CD7F32', next: 'Silver' };
        }

        const userLeague = getLeague(userProgress.xp || 0);
        document.getElementById('league-name').textContent = userLeague.name;
        
        // Update advancement text
        const advancementText = document.getElementById('league-advancement');
        if (userLeague.next) {
            advancementText.textContent = `Top 10 advance to ${userLeague.next}!`;
        } else {
            advancementText.textContent = 'Top League - Maintain Your Position!';
        }
        
        // Update icon color based on league
        const leagueIcon = document.getElementById('league-icon');
        const iconPath = leagueIcon.querySelector('path');
        iconPath.setAttribute('fill', userLeague.color);
        const userName = userProgress.userName || 'Player';
        const userXP = userProgress.xp || 0;
        const userQuestionStreak = userProgress.bestQuestionStreak || 0;

        // âœ… REFRESH STATS FROM LOCALSTORAGE (called when switching tabs)
        function refreshUserStats() {
            const freshProgress = JSON.parse(localStorage.getItem('reckonProgress') || '{"xp": 0, "userName": "Player", "bestQuestionStreak": 0}');
            return {
                userName: freshProgress.userName || 'Player',
                xp: freshProgress.xp || 0,
                questionStreak: freshProgress.bestQuestionStreak || 0
            };
        }

        // Track current leaderboard type
        let currentLeaderboardType = 'xp';

        // Generate REAL question streak leaderboard using actual localStorage data
        function generateQuestionStreakLeaderboard() {
            // âœ… Get FRESH stats from localStorage!
            const freshStats = refreshUserStats();
            
            // Get all localStorage keys that look like user progress
            const leaderboard = [];
            
            // Add current user with REAL FRESH stats
            leaderboard.push({
                name: freshStats.userName,
                streak: freshStats.questionStreak,
                isCurrentUser: true
            });
            
            // Generate mock competitors (in real app, this comes from server)
            const names = [
                'Alex Rivera', 'Jordan Chen', 'Taylor Kim', 'Morgan Patel', 'Casey Johnson', 
                'Riley Martinez', 'Avery Singh', 'Quinn O\'Brien', 'Blake Anderson', 'Drew Williams',
                'MathWiz47', 'AlgebraPro', 'EquationKing99', 'NumberNinja', 'CalcMaster23',
                'SolveItSam', 'FormulaFred', 'BalanceBoss', 'GraphGuru', 'VariableVicky'
            ];
            
            const usedNames = new Set([freshStats.userName]);
            
            // Generate 19 other players
            for (let i = 0; i < 19; i++) {
                let name;
                do {
                    name = names[Math.floor(Math.random() * names.length)];
                } while (usedNames.has(name));
                usedNames.add(name);
                
                // Generate realistic streak (weighted toward lower numbers)
                const rand = Math.random();
                let streak;
                if (rand < 0.3) {
                    streak = Math.floor(Math.random() * 5) + 1; // 1-5
                } else if (rand < 0.6) {
                    streak = Math.floor(Math.random() * 5) + 6; // 6-10
                } else if (rand < 0.85) {
                    streak = Math.floor(Math.random() * 5) + 11; // 11-15
                } else {
                    streak = Math.floor(Math.random() * 10) + 16; // 16-25
                }
                
                leaderboard.push({ name, streak });
            }
            
            // Sort by streak (highest first)
            leaderboard.sort((a, b) => b.streak - a.streak);
            
            return leaderboard;
        }

        // Generate mock leaderboard data (in real app, this would come from server)
        function generateLeaderboard() {
            // âœ… Get FRESH stats from localStorage!
            const freshStats = refreshUserStats();
            
            const fullNames = [
                'Alex Rivera', 'Jordan Chen', 'Taylor Kim', 'Morgan Patel', 'Casey Johnson', 
                'Riley Martinez', 'Avery Singh', 'Quinn O\'Brien', 'Blake Anderson', 'Drew Williams',
                'Reese Thompson', 'Sage Davis', 'Skylar Rodriguez', 'River Jackson'
            ];

            const usernames = [
                'MathWiz47', 'AlgebraPro', 'EquationKing99', 'NumberNinja', 'CalcMaster23',
                'FormulaFox', 'BrainiacBob', 'QuickSolver', 'LogicLuna88', 'TheoremThief',
                'BalanceGuru42', 'FigureHunter', 'XPChaser', 'StreakSeeker7'
            ];

            const countries = [
                { code: 'US', flag: 'ðŸ‡ºðŸ‡¸' },
                { code: 'CA', flag: 'ðŸ‡¨ðŸ‡¦' },
                { code: 'GB', flag: 'ðŸ‡¬ðŸ‡§' },
                { code: 'MX', flag: 'ðŸ‡²ðŸ‡½' },
                { code: 'BR', flag: 'ðŸ‡§ðŸ‡·' },
                { code: 'FR', flag: 'ðŸ‡«ðŸ‡·' },
                { code: 'DE', flag: 'ðŸ‡©ðŸ‡ª' },
                { code: 'IT', flag: 'ðŸ‡®ðŸ‡¹' },
                { code: 'ES', flag: 'ðŸ‡ªðŸ‡¸' },
                { code: 'JP', flag: 'ðŸ‡¯ðŸ‡µ' },
                { code: 'KR', flag: 'ðŸ‡°ðŸ‡·' },
                { code: 'IN', flag: 'ðŸ‡®ðŸ‡³' },
                { code: 'AU', flag: 'ðŸ‡¦ðŸ‡º' },
                { code: 'PL', flag: 'ðŸ‡µðŸ‡±' },
                { code: 'PH', flag: 'ðŸ‡µðŸ‡­' }
            ];

            const leaderboard = [];
            const usedNames = new Set([freshStats.userName]);
            
            // Generate 19 random players (so with current user = 20 total)
            for (let i = 0; i < 19; i++) {
                let name;
                let namePool;
                
                // Mix between full names and usernames
                if (Math.random() > 0.5) {
                    namePool = fullNames;
                } else {
                    namePool = usernames;
                }
                
                do {
                    name = namePool[Math.floor(Math.random() * namePool.length)];
                } while (usedNames.has(name));
                usedNames.add(name);
                
                const xp = Math.floor(Math.random() * 1200) + 50;
                
                // 70% chance to show country flag
                let country = null;
                if (Math.random() > 0.3) {
                    country = countries[Math.floor(Math.random() * countries.length)].flag;
                }
                
                leaderboard.push({ name, xp, country });
            }

            // Add current user (without flag by default, they're local)
            leaderboard.push({ name: freshStats.userName, xp: freshStats.xp, isCurrentUser: true });

            // Sort by XP
            leaderboard.sort((a, b) => b.xp - a.xp);

            return leaderboard;
        }

        // === FIREBASE LEADERBOARD ===
        let firebaseLeaderboard = null;
        let firebaseLeaderboardLoaded = false;

        // Fetch real users from Firebase
        async function getFirebaseLeaderboard() {
            try {
                // Check if Firebase is available
                if (!window.firebaseDB || !window.firebaseAuth) {
                    console.log('ðŸ“¦ Firebase not loaded - using local data');
                    return null;
                }

                // Sync localStorage to Firebase first
                if (window.autoSync) {
                    await window.autoSync.fullSync();
                }

                // Query all users sorted by XP
                const snapshot = await window.firebaseDB.collection('users')
                    .orderBy('xp', 'desc')
                    .limit(100)
                    .get();

                if (snapshot.empty) {
                    console.log('ðŸ“¦ No users in Firebase yet');
                    return null;
                }

                const freshStats = refreshUserStats();
                const currentUserId = window.firebaseAuth.currentUser?.uid;
                const leaderboard = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    leaderboard.push({
                        name: data.userName || 'Player',
                        xp: data.xp || 0,
                        streak: data.streak || 0,
                        isCurrentUser: doc.id === currentUserId,
                        country: null // Can add country data later
                    });
                });

                console.log('âœ… Loaded', leaderboard.length, 'users from Firebase');
                firebaseLeaderboard = leaderboard;
                firebaseLeaderboardLoaded = true;
                return leaderboard;

            } catch (error) {
                console.error('âŒ Firebase leaderboard error:', error);
                return null;
            }
        }

        // Get or generate persistent leaderboard
        async function getPersistentLeaderboard() {
            // âœ… Try Firebase first
            if (!firebaseLeaderboardLoaded) {
                const fbData = await getFirebaseLeaderboard();
                if (fbData && fbData.length > 0) {
                    return fbData;
                }
            } else if (firebaseLeaderboard) {
                return firebaseLeaderboard;
            }

            // âœ… Fall back to local/fake data
            // âœ… Get FRESH stats from localStorage!
            const freshStats = refreshUserStats();
            
            const saved = localStorage.getItem('reckonLeaderboard');
            const today = new Date().toDateString();
            
            if (saved) {
                const data = JSON.parse(saved);
                // Refresh leaderboard daily
                if (data.date === today) {
                    const leaderboard = data.leaderboard;
                    
                    // âœ… CRITICAL: Always update current user's XP with latest data!
                    const userIndex = leaderboard.findIndex(p => p.isCurrentUser);
                    if (userIndex !== -1) {
                        leaderboard[userIndex].xp = freshStats.xp;  // Use FRESH XP from localStorage!
                        leaderboard[userIndex].name = freshStats.userName;  // In case name changed
                        // Re-sort after updating user's XP
                        leaderboard.sort((a, b) => b.xp - a.xp);
                    }
                    
                    return leaderboard;
                }
            }
            
            // Generate new leaderboard with FRESH stats
            const newLeaderboard = generateLeaderboard();
            localStorage.setItem('reckonLeaderboard', JSON.stringify({
                date: today,
                leaderboard: newLeaderboard
            }));
            return newLeaderboard;
        }

        let currentLeaderboard = [];

        function getRankSuffix(rank) {
            if (rank === 1) return 'st';
            if (rank === 2) return 'nd';
            if (rank === 3) return 'rd';
            return 'th';
        }

        function renderLeaderboard() {
            if (!currentLeaderboard || currentLeaderboard.length === 0) {
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading leaderboard...</div>';
                return;
            }

            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';

            // Find user's rank
            const userRank = currentLeaderboard.findIndex(p => p.isCurrentUser) + 1;
            document.getElementById('user-rank').textContent = userRank;
            document.querySelector('.rank-suffix').textContent = getRankSuffix(userRank);
            
            // Update user stat display based on type
            if (currentLeaderboardType === 'xp') {
                document.getElementById('user-xp-display').textContent = userXP.toLocaleString();
                document.getElementById('user-stat-display').innerHTML = `<span id="user-xp-display">${userXP.toLocaleString()}</span> XP`;
            } else {
                document.getElementById('user-stat-display').innerHTML = `<span id="user-xp-display">${userQuestionStreak}</span> question streak`;
            }

            // Render top 20
            currentLeaderboard.slice(0, 20).forEach((player, index) => {
                const rank = index + 1;
                const div = document.createElement('div');
                
                let classes = 'leaderboard-item';
                if (rank <= 3) classes += ' top-3 rank-' + rank;
                if (player.isCurrentUser) classes += ' current-user';
                
                div.className = classes;

                let medalHTML = '';
                if (rank === 1) {
                    medalHTML = '<svg class="medal" viewBox="0 0 32 32"><path d="M 16 4 L 11 14 L 6 14 L 11 19 L 9 26 L 16 21 L 23 26 L 21 19 L 26 14 L 21 14 Z" fill="#FFD700"/></svg>';
                } else if (rank === 2) {
                    medalHTML = '<svg class="medal" viewBox="0 0 32 32"><path d="M 16 4 L 11 14 L 6 14 L 11 19 L 9 26 L 16 21 L 23 26 L 21 19 L 26 14 L 21 14 Z" fill="#C0C0C0"/></svg>';
                } else if (rank === 3) {
                    medalHTML = '<svg class="medal" viewBox="0 0 32 32"><path d="M 16 4 L 11 14 L 6 14 L 11 19 L 9 26 L 16 21 L 23 26 L 21 19 L 26 14 L 21 14 Z" fill="#CD7F32"/></svg>';
                }

                // Different display based on leaderboard type
                let statHTML = '';
                if (currentLeaderboardType === 'xp') {
                    statHTML = `
                        <div class="player-xp">
                            <svg class="xp-icon" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M7 2l-5 9h4l-4 11 13-11h-5l6-9z"/>
                            </svg>
                            ${player.xp.toLocaleString()}
                        </div>
                    `;
                } else {
                    statHTML = `
                        <div class="player-xp">
                            <svg class="xp-icon" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M7 2l-5 9h4l-4 11 13-11h-5l6-9z"/>
                            </svg>
                            ${player.streak} ðŸ”¥
                        </div>
                    `;
                }

                div.innerHTML = `
                    ${medalHTML || `<div class="rank">${rank}</div>`}
                    <div class="player-info">
                        <div class="avatar-small">${player.name[0].toUpperCase()}</div>
                        <div class="player-name">
                            ${player.name}
                            ${player.country ? `<span class="country-flag">${player.country}</span>` : ''}
                        </div>
                    </div>
                    ${statHTML}
                `;

                list.appendChild(div);
            });

            // Update footer stats based on type
            document.getElementById('total-players').textContent = currentLeaderboard.length;
            
            if (currentLeaderboardType === 'xp') {
                const avgXP = Math.floor(currentLeaderboard.reduce((sum, p) => sum + p.xp, 0) / currentLeaderboard.length);
                document.getElementById('avg-xp').textContent = avgXP.toLocaleString();
                document.getElementById('top-xp').textContent = currentLeaderboard[0].xp.toLocaleString();
                document.querySelector('.stats-grid .stat-item:nth-child(2) .stat-label').textContent = 'Avg XP';
                document.querySelector('.stats-grid .stat-item:nth-child(3) .stat-label').textContent = 'Top XP';
            } else {
                const avgStreak = Math.floor(currentLeaderboard.reduce((sum, p) => sum + p.streak, 0) / currentLeaderboard.length);
                document.getElementById('avg-xp').textContent = avgStreak;
                document.getElementById('top-xp').textContent = currentLeaderboard[0].streak;
                document.querySelector('.stats-grid .stat-item:nth-child(2) .stat-label').textContent = 'Avg Streak';
                document.querySelector('.stats-grid .stat-item:nth-child(3) .stat-label').textContent = 'Top Streak';
            }
        }

        async function switchLeaderboard(type) {
            // Update tab styles
            document.querySelectorAll('.time-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            currentLeaderboardType = type;
            
            if (type === 'xp') {
                currentLeaderboard = await getPersistentLeaderboard();
            } else {
                currentLeaderboard = generateQuestionStreakLeaderboard();
            }

            renderLeaderboard();
        }

        // Initialize leaderboard
        async function initLeaderboard() {
            currentLeaderboard = await getPersistentLeaderboard();
            renderLeaderboard();
        }

        // Initial render
        initLeaderboard();

        // âœ… Refresh leaderboard when page gains focus (user returns from completing figure)
        window.addEventListener('focus', async function() {
            // Refresh user stats and league
            const freshStats = refreshUserStats();
            const userLeague = getLeague(freshStats.xp);
            document.getElementById('league-name').textContent = userLeague.name;
            const leagueIcon = document.getElementById('league-icon');
            const iconPath = leagueIcon.querySelector('path');
            iconPath.setAttribute('fill', userLeague.color);
            
            // Regenerate current leaderboard with fresh stats
            if (currentLeaderboardType === 'xp') {
                currentLeaderboard = await getPersistentLeaderboard();
            } else {
                currentLeaderboard = generateQuestionStreakLeaderboard();
            }
            renderLeaderboard();
        });
    </script>

    <script>
        // Load theme
        function loadTheme() {
            const THEMES = {
                dark: { colors: { '--bg-primary': '#1F2937', '--bg-card': '#2D3748', '--bg-card-hover': '#374151', '--border': '#4A5568', '--border-hover': '#5a6573', '--text': '#ffffff', '--text-muted': '#9CA3AF', '--text-dim': '#6B7280', '--primary': '#58CC02', '--primary-dark': '#45A302', '--secondary': '#7C3AED', '--secondary-dark': '#5B21B6', '--accent': '#FFA500', '--accent-dark': '#FF6B00' }},
                light: { colors: { '--bg-primary': '#F9FAFB', '--bg-card': '#FFFFFF', '--bg-card-hover': '#F3F4F6', '--border': '#E5E7EB', '--border-hover': '#D1D5DB', '--text': '#1F2937', '--text-muted': '#6B7280', '--text-dim': '#9CA3AF', '--primary': '#10B981', '--primary-dark': '#059669', '--secondary': '#8B5CF6', '--secondary-dark': '#7C3AED', '--accent': '#F59E0B', '--accent-dark': '#D97706' }},
                ocean: { colors: { '--bg-primary': '#0F172A', '--bg-card': '#1E293B', '--bg-card-hover': '#334155', '--border': '#475569', '--border-hover': '#64748B', '--text': '#F1F5F9', '--text-muted': '#94A3B8', '--text-dim': '#64748B', '--primary': '#06B6D4', '--primary-dark': '#0891B2', '--secondary': '#3B82F6', '--secondary-dark': '#2563EB', '--accent': '#8B5CF6', '--accent-dark': '#7C3AED' }},
                sunset: { colors: { '--bg-primary': '#1C1917', '--bg-card': '#292524', '--bg-card-hover': '#44403C', '--border': '#57534E', '--border-hover': '#78716C', '--text': '#FAFAF9', '--text-muted': '#A8A29E', '--text-dim': '#78716C', '--primary': '#F97316', '--primary-dark': '#EA580C', '--secondary': '#EF4444', '--secondary-dark': '#DC2626', '--accent': '#FBBF24', '--accent-dark': '#F59E0B' }},
                forest: { colors: { '--bg-primary': '#14532D', '--bg-card': '#166534', '--bg-card-hover': '#15803D', '--border': '#16A34A', '--border-hover': '#22C55E', '--text': '#F0FDF4', '--text-muted': '#BBF7D0', '--text-dim': '#86EFAC', '--primary': '#4ADE80', '--primary-dark': '#22C55E', '--secondary': '#10B981', '--secondary-dark': '#059669', '--accent': '#FDE047', '--accent-dark': '#FACC15' }},
                midnight: { colors: { '--bg-primary': '#1E1B4B', '--bg-card': '#312E81', '--bg-card-hover': '#3730A3', '--border': '#4C1D95', '--border-hover': '#6D28D9', '--text': '#F5F3FF', '--text-muted': '#C4B5FD', '--text-dim': '#A78BFA', '--primary': '#A855F7', '--primary-dark': '#9333EA', '--secondary': '#EC4899', '--secondary-dark': '#DB2777', '--accent': '#F472B6', '--accent-dark': '#EC4899' }}
            };
            
            const savedTheme = localStorage.getItem('reckonTheme') || 'dark';
            const theme = THEMES[savedTheme];
            if (theme) {
                const root = document.documentElement;
                Object.entries(theme.colors).forEach(([property, value]) => {
                    root.style.setProperty(property, value);
                });
            }
        }
        loadTheme();
    </script>
</body>
</html>
