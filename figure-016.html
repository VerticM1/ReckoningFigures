<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figure 016: Graphing Inequalities</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: #1f2937;
            color: white;
            min-height: 100vh;
            overflow: hidden;
        }

        #game-container {
            max-width: 480px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        #top-bar {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 32px;
            cursor: pointer;
        }

        #progress-container {
            flex: 1;
            height: 16px;
            background: #374151;
            border-radius: 20px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Content */
        #content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #tutorial-screen, #interactive-screen, #question-screen {
            display: none;
        }

        #tutorial-screen.active, #interactive-screen.active, #question-screen.active {
            display: flex;
            flex-direction: column;
        }

        .tutorial-title {
            font-size: 28px;
            font-weight: 900;
            color: #fbbf24;
            margin-bottom: 20px;
            text-align: center;
        }

        .tutorial-text {
            font-size: 18px;
            font-weight: 700;
            color: #e5e7eb;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* Number Line SVG */
        .number-line-container {
            background: #374151;
            border-radius: 16px;
            padding: 30px 20px;
            margin-bottom: 30px;
        }

        .inequality-label {
            text-align: center;
            font-size: 32px;
            font-weight: 900;
            color: white;
            margin-bottom: 20px;
        }

        /* Interactive Controls */
        .interactive-question {
            font-size: 20px;
            font-weight: 800;
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }

        .interactive-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .interactive-btn {
            flex: 1;
            padding: 16px;
            background: #374151;
            border: 3px solid #4b5563;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }

        .interactive-btn:hover {
            border-color: #6b7280;
            background: #3f4651;
        }

        .interactive-btn.selected {
            border-color: #fbbf24;
            background: #92400e;
        }

        .interactive-btn.correct {
            border-color: #10b981;
            background: #065f46;
        }

        .interactive-btn.incorrect {
            border-color: #ef4444;
            background: #7f1d1d;
        }

        /* Regular Question */
        #question-text {
            font-size: 22px;
            font-weight: 800;
            color: white;
            margin-bottom: 30px;
        }

        .choice {
            width: 100%;
            padding: 18px 24px;
            background: #374151;
            border: 3px solid #4b5563;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 800;
            color: white;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            margin-bottom: 12px;
        }

        .choice:hover {
            border-color: #6b7280;
        }

        .choice.correct {
            border-color: #10b981;
            background: #065f46;
        }

        .choice.incorrect {
            border-color: #ef4444;
            background: #7f1d1d;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Bottom Controls */
        #bottom-section {
            margin-top: auto;
            padding: 20px;
        }

        #continue-btn {
            width: 100%;
            padding: 18px;
            background: #10b981;
            border: none;
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
            font-weight: 900;
            color: white;
            cursor: pointer;
            text-transform: uppercase;
        }

        #continue-btn:hover {
            background: #059669;
        }

        #continue-btn:disabled {
            background: #374151;
            cursor: not-allowed;
        }

        .feedback-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            min-height: 32px;
        }

        .check-icon {
            width: 32px;
            height: 32px;
            background: #10b981;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .check-icon.show {
            display: flex;
        }

        #feedback-text {
            font-size: 20px;
            font-weight: 900;
            color: #10b981;
        }

        /* Practice Summary Screen */
        #summary {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1F2937;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            padding: 40px 20px;
        }

        #summary.show {
            display: flex;
        }

        .summary-title {
            font-size: 48px;
            font-weight: 900;
            color: #FFA500;
            margin-bottom: 16px;
            text-align: center;
        }

        .summary-subtitle {
            font-size: 20px;
            font-weight: 700;
            color: #9CA3AF;
            margin-bottom: 50px;
            text-align: center;
        }

        .summary-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 50px;
            width: 100%;
            max-width: 500px;
        }

        .stat-card {
            flex: 1;
            border-radius: 20px;
            padding: 20px 16px;
            text-align: center;
            border: 3px solid;
        }

        .stat-card.xp {
            background: #1F2937;
            border-color: #FFA500;
        }

        .stat-card.accuracy {
            background: #1F2937;
            border-color: #58CC02;
        }

        .stat-card.time {
            background: #1F2937;
            border-color: #3B82F6;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .stat-card.xp .stat-label {
            color: #FFA500;
        }

        .stat-card.accuracy .stat-label {
            color: #58CC02;
        }

        .stat-card.time .stat-label {
            color: #3B82F6;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 900;
            color: white;
        }

        #claim-btn {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            background: #3B82F6;
            border: none;
            border-radius: 16px;
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
            font-weight: 900;
            color: white;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #claim-btn:hover {
            background: #2563EB;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Top Bar -->
        <div id="top-bar">
            <button class="close-btn" onclick="exitLesson()">×</button>
            <div id="progress-container">
                <div id="progress-fill"></div>
            </div>
        </div>

        <!-- Content -->
        <div id="content">
            <!-- Tutorial Screen -->
            <div id="tutorial-screen">
                <div class="tutorial-title" id="tutorial-title"></div>
                <div class="tutorial-text" id="tutorial-text"></div>
                <div class="number-line-container" id="tutorial-visual"></div>
            </div>

            <!-- Interactive Screen -->
            <div id="interactive-screen">
                <div class="interactive-question" id="interactive-question"></div>
                <div class="number-line-container" id="interactive-visual"></div>
                <div id="interactive-controls"></div>
            </div>

            <!-- Question Screen -->
            <div id="question-screen">
                <div id="question-text"></div>
                <div class="number-line-container" id="question-visual"></div>
                <div id="choices"></div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div id="bottom-section">
            <div class="feedback-container">
                <div class="check-icon">✓</div>
                <div id="feedback-text"></div>
            </div>
            <button id="continue-btn">Continue</button>
        </div>

    <!-- Summary Screen -->
    <div id="summary">
        <div class="summary-title" id="summary-title">Great Work!</div>
        <div class="summary-subtitle" id="summary-subtitle">You completed Figure 016!</div>
        
        <div class="summary-stats">
            <div class="stat-card xp">
                <div class="stat-label">Total XP</div>
                <div class="stat-value">
                    <span id="total-xp">0</span>
                </div>
            </div>
            
            <div class="stat-card accuracy">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value">
                    <span id="accuracy">100%</span>
                </div>
            </div>
            
            <div class="stat-card time">
                <div class="stat-label">Time</div>
                <div class="stat-value">
                    <span id="time">0:00</span>
                </div>
            </div>
        </div>
        
        <button id="claim-btn">Claim XP & Continue</button>
    </div>

    </div>

    <script>
        const state = {
            current: 0,
            mode: 'tutorial', // tutorial, interactive, question
            selected: null,
            correct: 0,
            total: 6, // 3 interactive + 3 multiple choice
            streak: 0,
            startTime: Date.now(),
            mistakes: 0,
            totalAttempts: 0,
            failedQuestions: new Set(),
            interactiveAnswer: {
                position: null,
                circleType: null,
                direction: null
            }
        };

        const content = [
            // Tutorial screens
            {
                mode: 'tutorial',
                title: 'Graphing Inequalities',
                text: 'Inequalities like x < 3 aren\'t just symbols - they represent ALL the numbers that make the inequality true. We show this on a number line!',
                visual: {type: 'basic-line'}
            },
            {
                mode: 'tutorial',
                title: 'Open Circles',
                text: 'For < and >, we use an OPEN circle. This means the number itself is NOT included. x < 3 means "less than 3, but not equal to 3".',
                visual: {type: 'open-circle', position: 3, shade: 'left', inequality: 'x < 3'}
            },
            {
                mode: 'tutorial',
                title: 'Closed Circles',
                text: 'For ≤ and ≥, we use a CLOSED circle. This means the number IS included. x ≤ 3 means "less than OR equal to 3".',
                visual: {type: 'closed-circle', position: 3, shade: 'left', inequality: 'x ≤ 3'}
            },
            {
                mode: 'tutorial',
                title: 'Shading Direction',
                text: '"Less than" (< or ≤) means shade LEFT. "Greater than" (> or ≥) means shade RIGHT. The shading shows all the numbers that work!',
                visual: {type: 'comparison', left: {pos: 2, type: 'open', dir: 'left', label: 'x < 2'}, right: {pos: 2, type: 'open', dir: 'right', label: 'x > 2'}}
            },

            // Interactive questions
            {
                mode: 'interactive',
                inequality: 'x > -1',
                question: 'Graph x > -1',
                correctAnswer: {position: -1, circleType: 'open', direction: 'right'}
            },
            {
                mode: 'interactive',
                inequality: 'x ≤ 2',
                question: 'Graph x ≤ 2',
                correctAnswer: {position: 2, circleType: 'closed', direction: 'left'}
            },
            {
                mode: 'interactive',
                inequality: 'x < 0',
                question: 'Graph x < 0',
                correctAnswer: {position: 0, circleType: 'open', direction: 'left'}
            },

            // Multiple choice questions
            {
                mode: 'question',
                inequality: 'x ≥ -3',
                question: 'Which is the correct graph for x ≥ -3?',
                choices: [
                    {text: 'Closed circle at -3, shade right', correct: true, visual: {pos: -3, type: 'closed', dir: 'right'}},
                    {text: 'Open circle at -3, shade right', correct: false, visual: {pos: -3, type: 'open', dir: 'right'}},
                    {text: 'Closed circle at -3, shade left', correct: false, visual: {pos: -3, type: 'closed', dir: 'left'}}
                ]
            },
            {
                mode: 'question',
                inequality: 'x < 4',
                question: 'Which statement is true?',
                choices: [
                    {text: 'The point x = 4 is included', correct: false},
                    {text: 'The point x = 4 is not included', correct: true},
                    {text: 'The point x = 4 might be included', correct: false}
                ]
            },
            {
                mode: 'question',
                inequality: 'x > 1',
                question: 'Which direction do we shade?',
                choices: [
                    {text: 'Right (toward positive numbers)', correct: true},
                    {text: 'Left (toward negative numbers)', correct: false},
                    {text: 'Both directions', correct: false}
                ]
            }
        ];

        // SVG Number Line Generator
        function createNumberLine(container, options = {}) {
            const {
                position = null,
                circleType = null,
                direction = null,
                showLabels = true,
                min = -5,
                max = 5
            } = options;

            const width = container.clientWidth || 400;
            const height = 100;
            const margin = 40;
            const lineY = height / 2;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', height);

            // Main line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', margin);
            line.setAttribute('y1', lineY);
            line.setAttribute('x2', width - margin);
            line.setAttribute('y2', lineY);
            line.setAttribute('stroke', '#9ca3af');
            line.setAttribute('stroke-width', '3');
            svg.appendChild(line);

            // Arrow
            const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            arrow.setAttribute('points', `${width - margin},${lineY} ${width - margin - 8},${lineY - 5} ${width - margin - 8},${lineY + 5}`);
            arrow.setAttribute('fill', '#9ca3af');
            svg.appendChild(arrow);

            // Tick marks and labels
            const range = max - min;
            const step = (width - 2 * margin) / range;

            for (let i = min; i <= max; i++) {
                const x = margin + (i - min) * step;
                
                // Tick mark
                const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                tick.setAttribute('x1', x);
                tick.setAttribute('y1', lineY - 8);
                tick.setAttribute('x2', x);
                tick.setAttribute('y2', lineY + 8);
                tick.setAttribute('stroke', '#9ca3af');
                tick.setAttribute('stroke-width', i === 0 ? '3' : '2');
                svg.appendChild(tick);

                // Label
                if (showLabels && i % 1 === 0) {
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', x);
                    label.setAttribute('y', lineY + 28);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('fill', '#e5e7eb');
                    label.setAttribute('font-size', '14');
                    label.setAttribute('font-weight', '700');
                    label.textContent = i;
                    svg.appendChild(label);
                }
            }

            // Shading
            if (position !== null && direction) {
                const posX = margin + (position - min) * step;
                const shade = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                shade.setAttribute('x1', direction === 'left' ? margin : posX);
                shade.setAttribute('y1', lineY);
                shade.setAttribute('x2', direction === 'left' ? posX : width - margin);
                shade.setAttribute('y2', lineY);
                shade.setAttribute('stroke', '#fbbf24');
                shade.setAttribute('stroke-width', '8');
                shade.setAttribute('opacity', '0.6');
                svg.appendChild(shade);

                // Arrow for shading direction
                const shadeArrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                if (direction === 'left') {
                    shadeArrow.setAttribute('points', `${margin},${lineY} ${margin + 10},${lineY - 6} ${margin + 10},${lineY + 6}`);
                } else {
                    shadeArrow.setAttribute('points', `${width - margin},${lineY} ${width - margin - 10},${lineY - 6} ${width - margin - 10},${lineY + 6}`);
                }
                shadeArrow.setAttribute('fill', '#fbbf24');
                svg.appendChild(shadeArrow);
            }

            // Circle at position
            if (position !== null && circleType) {
                const posX = margin + (position - min) * step;
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', posX);
                circle.setAttribute('cy', lineY);
                circle.setAttribute('r', '8');
                circle.setAttribute('fill', circleType === 'closed' ? '#fbbf24' : '#1f2937');
                circle.setAttribute('stroke', '#fbbf24');
                circle.setAttribute('stroke-width', '4');
                svg.appendChild(circle);
            }

            return svg;
        }

        function showTutorial() {
            const item = content[state.current];
            document.getElementById('tutorial-screen').classList.add('active');
            document.getElementById('interactive-screen').classList.remove('active');
            document.getElementById('question-screen').classList.remove('active');

            document.getElementById('tutorial-title').textContent = item.title;
            document.getElementById('tutorial-text').textContent = item.text;

            const visualContainer = document.getElementById('tutorial-visual');
            visualContainer.innerHTML = '';

            if (item.visual.type === 'basic-line') {
                visualContainer.appendChild(createNumberLine(visualContainer, {}));
            } else if (item.visual.type === 'open-circle') {
                const label = document.createElement('div');
                label.className = 'inequality-label';
                label.textContent = item.visual.inequality;
                visualContainer.appendChild(label);
                visualContainer.appendChild(createNumberLine(visualContainer, {
                    position: item.visual.position,
                    circleType: 'open',
                    direction: item.visual.shade
                }));
            } else if (item.visual.type === 'closed-circle') {
                const label = document.createElement('div');
                label.className = 'inequality-label';
                label.textContent = item.visual.inequality;
                visualContainer.appendChild(label);
                visualContainer.appendChild(createNumberLine(visualContainer, {
                    position: item.visual.position,
                    circleType: 'closed',
                    direction: item.visual.shade
                }));
            } else if (item.visual.type === 'comparison') {
                // Split view
                const leftDiv = document.createElement('div');
                leftDiv.style.marginBottom = '20px';
                const leftLabel = document.createElement('div');
                leftLabel.className = 'inequality-label';
                leftLabel.textContent = item.visual.left.label;
                leftDiv.appendChild(leftLabel);
                leftDiv.appendChild(createNumberLine(leftDiv, {
                    position: item.visual.left.pos,
                    circleType: item.visual.left.type,
                    direction: item.visual.left.dir
                }));
                visualContainer.appendChild(leftDiv);

                const rightDiv = document.createElement('div');
                const rightLabel = document.createElement('div');
                rightLabel.className = 'inequality-label';
                rightLabel.textContent = item.visual.right.label;
                rightDiv.appendChild(rightLabel);
                rightDiv.appendChild(createNumberLine(rightDiv, {
                    position: item.visual.right.pos,
                    circleType: item.visual.right.type,
                    direction: item.visual.right.dir
                }));
                visualContainer.appendChild(rightDiv);
            }

            document.getElementById('continue-btn').disabled = false;
        }

        function showInteractive() {
            const item = content[state.current];
            document.getElementById('tutorial-screen').classList.remove('active');
            document.getElementById('interactive-screen').classList.add('active');
            document.getElementById('question-screen').classList.remove('active');

            document.getElementById('interactive-question').textContent = item.question;

            const visualContainer = document.getElementById('interactive-visual');
            visualContainer.innerHTML = '';
            const label = document.createElement('div');
            label.className = 'inequality-label';
            label.textContent = item.inequality;
            visualContainer.appendChild(label);
            visualContainer.appendChild(createNumberLine(visualContainer, {
                position: state.interactiveAnswer.position,
                circleType: state.interactiveAnswer.circleType,
                direction: state.interactiveAnswer.direction
            }));

            const controls = document.getElementById('interactive-controls');
            controls.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div class="tutorial-text" style="font-size: 16px; margin-bottom: 12px;">What type of circle?</div>
                    <div class="interactive-buttons">
                        <button class="interactive-btn" onclick="selectCircleType('open')">Open Circle</button>
                        <button class="interactive-btn" onclick="selectCircleType('closed')">Closed Circle</button>
                    </div>
                </div>
                <div>
                    <div class="tutorial-text" style="font-size: 16px; margin-bottom: 12px;">Which direction to shade?</div>
                    <div class="interactive-buttons">
                        <button class="interactive-btn" onclick="selectDirection('left')">← Left</button>
                        <button class="interactive-btn" onclick="selectDirection('right')">Right →</button>
                    </div>
                </div>
            `;

            // Parse position from inequality
            const match = item.inequality.match(/[<>≤≥]\s*([-\d]+)/);
            if (match) {
                state.interactiveAnswer.position = parseInt(match[1]);
            }

            document.getElementById('continue-btn').disabled = true;
        }

        function selectCircleType(type) {
            state.interactiveAnswer.circleType = type;
            document.querySelectorAll('.interactive-buttons')[0].querySelectorAll('.interactive-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.toLowerCase().includes(type)) {
                    btn.classList.add('selected');
                }
            });
            updateInteractiveVisual();
            checkInteractiveAnswer();
        }

        function selectDirection(dir) {
            state.interactiveAnswer.direction = dir;
            document.querySelectorAll('.interactive-buttons')[1].querySelectorAll('.interactive-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.toLowerCase().includes(dir)) {
                    btn.classList.add('selected');
                }
            });
            updateInteractiveVisual();
            checkInteractiveAnswer();
        }

        function updateInteractiveVisual() {
            const visualContainer = document.getElementById('interactive-visual');
            visualContainer.innerHTML = '';
            const label = document.createElement('div');
            label.className = 'inequality-label';
            label.textContent = content[state.current].inequality;
            visualContainer.appendChild(label);
            visualContainer.appendChild(createNumberLine(visualContainer, {
                position: state.interactiveAnswer.position,
                circleType: state.interactiveAnswer.circleType,
                direction: state.interactiveAnswer.direction
            }));
        }

        function checkInteractiveAnswer() {
            const item = content[state.current];
            const correct = item.correctAnswer;
            
            if (state.interactiveAnswer.circleType && state.interactiveAnswer.direction) {
                const isCorrect = 
                    state.interactiveAnswer.circleType === correct.circleType &&
                    state.interactiveAnswer.direction === correct.direction;

                if (isCorrect) {
                    if (!state.failedQuestions.has(state.current)) {
                        state.correct++;
                    }
                    document.getElementById('feedback-text').textContent = 'Perfect!';
                    document.querySelector('.check-icon').classList.add('show');
                    document.getElementById('continue-btn').disabled = false;

                    // Mark buttons as correct
                    document.querySelectorAll('.interactive-btn.selected').forEach(btn => {
                        btn.classList.add('correct');
                        btn.classList.remove('selected');
                    });
                } else {
                    state.failedQuestions.add(state.current);
                    document.getElementById('feedback-text').textContent = 'Try again!';
                    document.getElementById('feedback-text').style.color = '#ef4444';
                    
                    // Mark buttons as incorrect
                    document.querySelectorAll('.interactive-btn.selected').forEach(btn => {
                        btn.classList.add('incorrect');
                        setTimeout(() => {
                            btn.classList.remove('incorrect', 'selected');
                        }, 800);
                    });

                    // Reset answer
                    setTimeout(() => {
                        state.interactiveAnswer.circleType = null;
                        state.interactiveAnswer.direction = null;
                        document.getElementById('feedback-text').textContent = '';
                    }, 1000);
                }
            }
        }

        function showQuestion() {
            const item = content[state.current];
            document.getElementById('tutorial-screen').classList.remove('active');
            document.getElementById('interactive-screen').classList.remove('active');
            document.getElementById('question-screen').classList.add('active');

            document.getElementById('question-text').textContent = item.question;

            // Show visual if available
            const visualContainer = document.getElementById('question-visual');
            visualContainer.innerHTML = '';
            if (item.inequality) {
                const label = document.createElement('div');
                label.className = 'inequality-label';
                label.textContent = item.inequality;
                visualContainer.appendChild(label);
            }

            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';
            
            item.choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice';
                btn.textContent = choice.text;
                btn.onclick = () => selectChoice(index);
                choicesContainer.appendChild(btn);
            });

            document.getElementById('continue-btn').disabled = true;
        }

        function selectChoice(index) {
            if (state.selected !== null) return;
            
            state.selected = index;
            const item = content[state.current];
            const btns = document.querySelectorAll('.choice');
            
            btns.forEach((btn, i) => {
                btn.disabled = true;
                if (i === index) {
                    const isCorrect = item.choices[index].correct;
                    
                    setTimeout(() => {
                        if (isCorrect) {
                            btn.classList.add('correct');
                            if (!state.failedQuestions.has(state.current)) {
                                state.correct++;
                            }
                            document.getElementById('feedback-text').textContent = 'Correct!';
                            document.querySelector('.check-icon').classList.add('show');
                            document.getElementById('continue-btn').disabled = false;
                        } else {
                            btn.classList.add('incorrect');
                            state.failedQuestions.add(state.current);
                            document.getElementById('feedback-text').textContent = 'Try again!';
                            document.getElementById('feedback-text').style.color = '#ef4444';
                            
                            setTimeout(() => {
                                btn.classList.remove('incorrect');
                                btns.forEach(b => b.disabled = false);
                                state.selected = null;
                                document.getElementById('feedback-text').textContent = '';
                            }, 1200);
                        }
                    }, 300);
                }
            });
        }

        function showCurrent() {
            const item = content[state.current];
            
            // Reset state
            state.selected = null;
            state.interactiveAnswer = {position: null, circleType: null, direction: null};
            document.getElementById('feedback-text').textContent = '';
            document.getElementById('feedback-text').style.color = '#10b981';
            document.querySelector('.check-icon').classList.remove('show');

            // Update progress - use content.length for total screens
            document.getElementById('progress-fill').style.width = ((state.current / content.length) * 100) + '%';

            if (item.mode === 'tutorial') {
                showTutorial();
            } else if (item.mode === 'interactive') {
                showInteractive();
            } else if (item.mode === 'question') {
                showQuestion();
            }
        }

        function nextItem() {
            state.current++;
            if (state.current < content.length) {
                showCurrent();
            } else {
                showVictory();
            }
        }

        function showVictory() {
            const perfect = state.correct === state.total;
            const timeElapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const minutes = Math.floor(timeElapsed / 60);
            const seconds = timeElapsed % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const accuracy = Math.round((state.correct / state.total) * 100);
            const xp = state.correct * 10 + (perfect ? 50 : 0);
            
            // Update summary screen
            if (perfect && state.mistakes === 0) {
                document.getElementById('summary-title').textContent = 'Perfect Score!';
                document.getElementById('summary-subtitle').textContent = 'You mastered graphing inequalities!';
            } else {
                document.getElementById('summary-title').textContent = 'Great Work!';
                document.getElementById('summary-subtitle').textContent = 'You completed Figure 016!';
            }
            
            document.getElementById('total-xp').textContent = xp;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('time').textContent = timeString;
            
            document.getElementById('summary').classList.add('show');
        }

        // Claim XP and continue
        const claimBtn = document.getElementById('claim-btn');
        if (claimBtn) {
            claimBtn.addEventListener('click', () => {
                try {
                    const accuracy = Math.round((state.correct / state.total) * 100);
                    const earnedXP = state.correct * 10 + (state.correct === state.total ? 50 : 0);
                    
                    // Get current progress
                    let currentProgress = JSON.parse(localStorage.getItem('reckonProgress') || '{"xp": 0, "completed": [], "dailyStreak": 0}');
                    
                    // Add XP
                    currentProgress.xp = (currentProgress.xp || 0) + earnedXP;
                    
                    // Mark as completed
                    if (!currentProgress.completed) {
                        currentProgress.completed = [];
                    }
                    
                    if (!currentProgress.completed.includes(16)) {
                        currentProgress.completed.push(16);
                    }
                    
                    localStorage.setItem('reckonProgress', JSON.stringify(currentProgress));
                    
                    // Navigate to module 2
                    window.location.href = `module-2-simple.html?completed=16&xp=${earnedXP}&questionStreak=${state.streak}`;
                } catch (e) {
                    console.error('Claim XP error:', e);
                    alert('Error saving progress: ' + e.message);
                }
            });
        }

        function exitLesson() {
            if (confirm('Exit lesson? Your progress will be lost.')) {
                window.location.href = 'module-2-simple.html';
            }
        }

        document.getElementById('continue-btn').addEventListener('click', nextItem);
        
        showCurrent();
    </script>
</body>
</html>
